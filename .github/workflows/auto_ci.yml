name: Auto CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      BLPAPI_ROOT: /home/bbg
    strategy:
      matrix:
        python-version: ["3.7", "3.9", "3.11", "3.13", "3.14"]
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv (Linux)
      if: runner.os == 'Linux'
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
    - name: Install uv (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        irm https://astral.sh/uv/install.ps1 | iex
    - name: Sync dependencies with uv
      run: |
        uv --version
        uv sync --locked --extra dev --extra test
    - name: Lint with flake8
      run: |
        uv run flake8 --extend-ignore=E701,E501 xbbg
    - name: Test with pytest
      run: |
        uv run pytest --doctest-modules --cov -v xbbg
    - name: Coverage report
      run: |
        uv run codecov --token=ff17768d-30bd-4917-98f2-a011606597ea
